//
//  CCTrendDetailVC.m
//  16Street
//
//  Created by apple on 2018/11/23.
//  Copyright ¬© 2018Âπ¥ toerax. All rights reserved.
//

#import "CCTrendDetailVC.h"

#import "CCTrendDetailViewModel.h"

#import "CCTrendDetailBarView.h"
#import "CCTrendDetailView.h"

#import "CCDetailView.h"
#import "CCCommentTextView.h"

#import "CCCommentCell.h"
#import "CCCommentHeader.h"
#import "CCCommentFooter.h"

#import <IQKeyboardManager.h>
@interface CCTrendDetailVC ()<UITableViewDelegate,UITableViewDataSource,UITextViewDelegate>
//‰∏ªËßÜÂõæ
@property (strong,nonatomic)CCTrendDetailView      *trendView;
//‰∏ãËæπÂ∑•ÂÖ∑Ê†è
@property (strong,nonatomic)CCTrendDetailBarView   *barView;
//webView
@property (strong,nonatomic)CCDetailView           *detailView;
//ÈîÆÁõòËæìÂÖ•Ê°Ü
@property (strong,nonatomic)CCCommentTextView      *textView;
//ËØÑËÆ∫ViewModel
@property (strong,nonatomic)CCTrendDetailViewModel *viewModel;
//Áî®Êà∑‰ø°ÊÅØÊ®°Âûã
@property (strong,nonatomic)CCLoginModel *userInfo;

//header
@property (strong,nonatomic)CCCommentHeader *headerView;
//footer
@property (strong,nonatomic)CCCommentFooter *footerView;

//Êï∞ÊçÆÊï∞ÁªÑÔºàÈáåÈù¢Ë£Ö‰∫ÜËØÑËÆ∫Ê®°ÂûãÔºâ
@property(strong,nonatomic)NSMutableArray *commentArray;

@end

static NSString *const cellIdentifier = @"CCCommentCell";

@implementation CCTrendDetailVC



- (void)viewDidLoad {
    [super viewDidLoad];
    [MBManager showLoadingInView:self.view];
    self.userInfo = [CCArchiveManager unarchiveObjectWithfilePath:UserInfoPath];
    [self webViewLoad];
    [self setUpUI];
    [self layout];
    [self block];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyBoardWillShow:) name:UIKeyboardWillShowNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(keyBoardWillHide:) name:UIKeyboardWillHideNotification object:nil];
}

- (void)setUpUI{
    
    [self.view addSubview:self.trendView];
    [self.view addSubview:self.barView];
    [self.view addSubview:self.textView];
    
}

- (void)block{
    WeakSelf(self);
    //:webÂä†ËΩΩÂÆåÊàêÂõûË∞ÉÔºõ
    [self.detailView setGetWebHeightBlock:^(CGFloat height) {
        NSLog(@"%.2f",height);
        weakself.detailView.frame = CGRectMake(0, 0, SCREEN_WIDTH, height);
        weakself.detailView.webView.frame = CGRectMake(0, 0, SCREEN_WIDTH, height);
        [weakself loadData];
    }];
    
    [self.barView setBarBtnBlock:^(NSInteger index) {
       
        switch (index) {
            case 0://ÂàÜ‰∫´
                
                break;
            case 1://ËØÑËÆ∫
            {
                
                 NSLog(@"index = %ld",(long)index);
                [weakself.textView.textView becomeFirstResponder];
                
            }
                break;
            case 2://ÁÇπËµû
                {
                    
                }
                
                break;
            default:
                break;
        }
    }];
    
    [self.textView setButtonBlock:^(NSInteger tag) {
        [weakself.view endEditing:YES];
        if (tag== 0) {//ÂèñÊ∂à
            
        }else{//ËØÑËÆ∫
            NSDictionary *params = @{@"pId":@"0",@"id":CHECK_STRING(weakself.userInfo.Id) ,@"type":weakself.type,@"content":weakself.textView.textView.text,@"fkId":weakself.model.Id};
            [weakself addComentWithParams:params];
        }
    }];
    
   
}
#pragma mark ************* Action************

///MARK:--alert‰∫ã‰ª∂
-(void)aleartClickWithIndex:(NSInteger)index model:(CCCommendListModel *)model{
    
    if ([model.TelePhone isEqualToString:self.userInfo.phone]) {
        switch (index) {
            case 0://Â§çÂà∂
                [self copyCommentWithModel:model];
                break;
            case 1://Âà†Èô§
               {
                   NSDictionary *dic = @{@"id":self.userInfo.Id,@"cId":model.KeyID};
                   [self deleteComentWithParams:dic];
                
               }
                break;
                
            default:
                break;
        }
    }else{
        switch (index) {
            case 0://ÂõûÂ§ç
                 {
                     
                     [self.textView.textView becomeFirstResponder];
                     
//                 NSDictionary *params = @{@"pId":model.KeyID,@"id":CHECK_STRING(self.userInfo.Id) ,@"type":self.type,@"content":@"666 üòÇ",@"fkId":self.model.Id};
//                 [self addComentWithParams:params];
                     
                 }
                
                break;
            case 1://Â§çÂà∂
                [self copyCommentWithModel:model];
                break;
            case 2://‰∏æÊä•
                [self reportCommentWithModel:model];
                break;
                
            default:
                break;
        }
    }
    
}

#pragma mark ************* Êï∞ÊçÆËØ∑Ê±Ç************
- (void)loadData{
    WeakSelf(self);
    NSDictionary *dic = @{@"id":CHECK_STRING(self.userInfo.Id),@"type":self.type,@"page":@"1",@"rows":@"20",@"fkId":self.model.Id};
    NSLog(@"dic = %@",dic);
    [MBManager dismiss];
    [self.viewModel requestCommentListWith:dic success:^(NSArray * _Nonnull models) {
        weakself.commentArray = models.mutableCopy;
        [weakself.trendView.tableView reloadData];
    } failure:^(NSError * _Nonnull error) {
        
    }];
    
}

///MARK:--Âà†Èô§ËØÑËÆ∫
- (void)deleteComentWithParams:(NSDictionary *)params{
    WeakSelf(self);
    [self.viewModel deleteCommentWithParams:params success:^{
        [weakself loadData];
    } failure:^(NSError * _Nonnull error) {
        
    }];
}

///MARK:--Ê∑ªÂä†ËØÑËÆ∫
- (void)addComentWithParams:(NSDictionary *)params{
    WeakSelf(self);
    [self.viewModel addCommentWithParams:params success:^() {
        [weakself loadData];
    } failure:^(NSError * _Nonnull error) {
        
    }];
   
}
///MARK:--‰∏æÊä•ËØÑËÆ∫
- (void)reportCommentWithModel:(CCCommendListModel *)model{
    
}
///MARK:--Â§çÂà∂ËØÑËÆ∫
- (void)copyCommentWithModel:(CCCommendListModel *)model{
    
}

#pragma mark ************* Êéß‰ª∂Á∫¶Êùü************
-(void)layout{
    //Â∑•ÂÖ∑Ê†èÁ∫¶Êùü
    [self.barView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.width.left.bottom.mas_equalTo(self.view);
        make.height.mas_equalTo(50 + NoTababarHeight);
    }];
    
    //‰∏ªËßÜÂõæÁ∫¶Êùü
    [self.trendView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.bottom.mas_equalTo(self.barView.mas_top);
        make.top.left.width.mas_equalTo(self.view);
    }];
    
    [self.textView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_equalTo(self.view);
        make.height.mas_equalTo(150);
        make.top.mas_equalTo(self.view.mas_bottom);
    }];
    
}

///MARKÔºö--Âä†ËΩΩwebView
- (void)webViewLoad{
    NSString *urlString = [NSString stringWithFormat:@"%@web/trend?id=%@&fkId=%@",BaseURL,_model.Id,CHECK_STRING(self.userInfo.Id)];
    _detailView = [[CCDetailView alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 1) urlString:urlString];
}

#pragma mark ************* ÊáíÂä†ËΩΩ************
///MAERKÔºö--Êï∞ÊçÆÊ∫ê
-(NSMutableArray *)commentArray{
    if (!_commentArray) {
        _commentArray = [NSMutableArray array];
    }
    return _commentArray;
}

///MAERKÔºö--Â∑•ÂÖ∑Ê†è
-(CCTrendDetailBarView *)barView{
    if (!_barView) {
        _barView = [[CCTrendDetailBarView alloc]init];
    }
    return _barView;
}

///MAERKÔºö--‰∏ªËßÜÂõæ
-(CCTrendDetailView *)trendView{
    if (!_trendView) {
        _trendView = [[CCTrendDetailView alloc]init];
        _trendView.tableView.delegate = self;
        _trendView.tableView.dataSource = self;
        _trendView.tableView.tableHeaderView = self.detailView;
        [_trendView.tableView registerNib:[UINib nibWithNibName:NSStringFromClass([CCCommentCell class]) bundle:nil] forCellReuseIdentifier:cellIdentifier];
        
    }
    return _trendView;
}

-(CCCommentTextView *)textView{
    if (!_textView) {
        _textView = [[CCCommentTextView alloc]init];
    }
    return _textView;
}

///MAERKÔºö--ViewModel
-(CCTrendDetailViewModel *)viewModel{
    if (!_viewModel) {
        _viewModel = [[CCTrendDetailViewModel alloc]init];
    }
    return _viewModel;
}


#pragma mark ************* UITableViewDataSource && UITableViewDelegate************
///MARKÔºö--section‰∏™Êï∞
-(NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    
    return self.commentArray.count;
}

///MARKÔºö--ÊØè‰∏™sectionÁöÑcell‰∏™Êï∞
-(NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    
    CCCommendListModel *model = [CCCommendListModel mj_objectWithKeyValues:self.commentArray[section]];
    NSLog(@"count = %lu",(unsigned long)model.SubComments.count);
    return model.SubComments.count;
}

///MARKÔºö--ËÆæÁΩÆÊï∞ÊçÆÊ∫ê
-(UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    CCCommendListModel *model = [CCCommendListModel mj_objectWithKeyValues:self.commentArray[indexPath.section]];
     CCCommendListModel *subModel = [CCCommendListModel mj_objectWithKeyValues:model.SubComments[indexPath.row]];
    CCCommentCell *cell = [tableView dequeueReusableCellWithIdentifier:cellIdentifier];
    if (!cell) {
        cell = [[CCCommentCell alloc]initWithStyle:(UITableViewCellStyleDefault) reuseIdentifier:cellIdentifier];
        
    }
    cell.selectionStyle = UITableViewCellSelectionStyleNone;
   
    cell.model = subModel;
    return cell;
}

///MARKÔºö--hedear
-(UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    
    CCCommendListModel *model = [CCCommendListModel mj_objectWithKeyValues:self.commentArray[section]];
    CGFloat height = [NSString getTextSizeWithStr:model.Content withSize:CGSizeMake(SCREEN_WIDTH - 96, MAXFLOAT) withFont:SYSTEMFONT(12)].height;
    _headerView = [[CCCommentHeader alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, height)];
    _headerView.model = model;
    return self.headerView;
    
}

///MARKÔºö--footer
- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    WeakSelf(self);
    CCCommendListModel *model = [CCCommendListModel mj_objectWithKeyValues:self.commentArray[section]];
    _footerView = [[CCCommentFooter alloc]initWithFrame:CGRectMake(0, 0, SCREEN_WIDTH, 20)];
    _footerView.model = model;
    [_footerView setFooterBlock:^{
        NSArray *buttonArr;
        if ([model.TelePhone isEqualToString:weakself.userInfo.phone]) {
            buttonArr = @[@"Â§çÂà∂",@"Âà†Èô§",@"ÂèñÊ∂à"];
        }else{
            buttonArr = @[@"ÂõûÂ§ç",@"Â§çÂà∂",@"‰∏æÊä•",@"ÂèñÊ∂à"];
        }
        [weakself showAleratWithModel:model buttonArray:buttonArr];
       
    }];
    return self.footerView;
}

///MARKÔºö--cellÈÄâ‰∏≠‰∫ã‰ª∂
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    CCCommendListModel *model = [CCCommendListModel mj_objectWithKeyValues:self.commentArray[indexPath.section]];
    CCCommendListModel *cellModel = [CCCommendListModel mj_objectWithKeyValues:model.SubComments[indexPath.row]];
    NSArray *buttonArr;
    if ([cellModel.TelePhone isEqualToString:self.userInfo.phone]) {
        buttonArr = @[@"Â§çÂà∂",@"Âà†Èô§",@"ÂèñÊ∂à"];
    }else{
        buttonArr = @[@"ÂõûÂ§ç",@"Â§çÂà∂",@"‰∏æÊä•",@"ÂèñÊ∂à"];
    }
    [self showAleratWithModel:cellModel buttonArray:buttonArr];
    
}

- (void)showAleratWithModel:(CCCommendListModel *)model buttonArray:(NSArray *)buttonArray{
    [self showAlertWithTitle:@"ËØÑËÆ∫" message:@"" type:(UIAlertControllerStyleActionSheet) buttonArr:buttonArray alerAction:^(NSInteger index) {
        [self aleartClickWithIndex:index model:model];
    }];
}


#pragma mark ************* ÁõëÂê¨************
#pragma mark -ÈîÆÁõòÁõëÂê¨ÊñπÊ≥ï
- (void)keyBoardWillShow:(NSNotification *)notification
{
    //     Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    NSDictionary *userInfo = [NSDictionary dictionaryWithDictionary:notification.userInfo];
    // Ëé∑ÂèñÈîÆÁõòÈ´òÂ∫¶
    CGRect keyBoardBounds  = [[userInfo objectForKey:UIKeyboardFrameEndUserInfoKey] CGRectValue];
    CGFloat keyBoardHeight = keyBoardBounds.size.height;
    // Ëé∑ÂèñÈîÆÁõòÂä®ÁîªÊó∂Èó¥
    CGFloat animationTime  = [[userInfo objectForKey:UIKeyboardAnimationDurationUserInfoKey] floatValue];

    // ÂÆö‰πâÂ•ΩÂä®‰Ωú
    void (^animation)(void) = ^void(void) {
        self.textView.transform = CGAffineTransformMakeTranslation(0, -(keyBoardHeight + 150));
    };

    if (animationTime > 0) {
        [UIView animateWithDuration:animationTime animations:animation];
    } else {
        animation();
    }
}

//ÈîÆÁõòÂõûÊî∂
- (void)keyBoardWillHide:(NSNotification *)notificaiton
{
    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ
    NSDictionary *userInfo = [NSDictionary dictionaryWithDictionary:notificaiton.userInfo];
    // Ëé∑ÂèñÈîÆÁõòÂä®ÁîªÊó∂Èó¥

    CGFloat animationTime= [[userInfo objectForKey:UIKeyboardAnimationDurationUserInfoKey] floatValue];
    // ÂÆö‰πâÂ•ΩÂä®‰Ωú
    void (^animation)(void) = ^void(void) {
        self.textView.transform = CGAffineTransformIdentity;
    };

    if (animationTime > 0) {
        [UIView animateWithDuration:animationTime animations:animation];
    } else {
        animation();
    }
   
}

@end
